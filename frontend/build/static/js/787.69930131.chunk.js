"use strict";(self.webpackChunktranslate_editor=self.webpackChunktranslate_editor||[]).push([[787],{2787:(e,t,n)=>{n.r(t),n.d(t,{default:()=>y});var s=n(5043),a=n(2200),o=n(2802),i=n(544),l=n(7591),c=n(115),r=n(4058),d=n(6468),u=n(7176),h=n(579);const m=(0,s.lazy)((()=>n.e(244).then(n.bind(n,1244)))),g=(0,s.lazy)((()=>n.e(31).then(n.bind(n,31)))),f=(0,s.lazy)((()=>n.e(872).then(n.bind(n,9872)))),p="unsubmitted",x="submitted",b="viewing_receipt",v=e=>{let{data:t,onClose:v}=e;const y=(0,i.T)(),j=(0,s.useRef)(t),[w,N]=(0,s.useState)(!1),[k,C]=(0,s.useState)(!1),[T,S]=(0,s.useState)(""),[_,A]=(0,s.useState)([]),[E,P]=(0,s.useState)(!1),[F,$]=(0,s.useState)(""),[H,D]=(0,s.useState)(!0),[M,B]=(0,s.useState)(null),[I,R]=(0,s.useState)(!1),[L,G]=(0,s.useState)(p),[O,z]=(0,s.useState)(null),[U,V]=(0,s.useState)(!1),[K,J]=(0,s.useState)([]);(0,s.useEffect)((()=>{n.e(31).then(n.bind(n,31)),n.e(872).then(n.bind(n,9872))}),[]);const Y=(0,s.useMemo)((()=>(0,o.GP)(new Date,"dd/MM/yyyy")),[]),q=(0,s.useMemo)((()=>j.current?`${j.current.sur_name} ${j.current.name}`:""),[]);(0,s.useEffect)((()=>{j.current=t,null!==t&&void 0!==t&&t.mshs&&B(t.mshs)}),[t]),(0,s.useEffect)((()=>{const e=e=>{if(O)return e.preventDefault(),e.returnValue="B\u1ea1n c\xf3 giao d\u1ecbch ch\u01b0a ho\xe0n th\xe0nh. N\u1ebfu r\u1eddi kh\u1ecfi trang, d\u1eef li\u1ec7u s\u1ebd b\u1ecb hu\u1ef7.",e.returnValue};return window.addEventListener("beforeunload",e),()=>{window.removeEventListener("beforeunload",e)}}),[O]),(0,s.useEffect)((()=>{const e=()=>{if(O){const e=`${y}/api/invoice/delete/${O}`;navigator.sendBeacon(e,null)}};return window.addEventListener("unload",e),()=>{window.removeEventListener("unload",e)}}),[O,y]);const{loading:Q,feeTable:W,processedFees:X,currentMonth:Z,transactionId:ee,error:te,fetchTuitionFeeData:ne,pendingInvoice:se,totalFeeAmount:ae,deletePendingInvoice:oe}=(0,r._)(M,!0);(0,s.useEffect)((()=>{if(X&&Array.isArray(X)&&X.length>0&&!U){const e=X.map((e=>{var t,n,s;return{...e,isChecked:!0,amount_paid:null!==(t=null!==(n=e.amount_paid)&&void 0!==n?n:e.suggested_payment)&&void 0!==t?t:0,note:null!==(s=e.note)&&void 0!==s?s:""}})).sort(((e,t)=>{const n=e.code&&e.code.includes("HP"),s=t.code&&t.code.includes("HP");return n&&!s?-1:!n&&s?1:0}));if(J(e),V(!0),e.length>0&&Z){const t=e.map((e=>e.code));A(t),S(`THU ${t.join(", ")} TH\xc1NG ${Z}`)}}}),[X,U,Z]),(0,s.useEffect)((()=>{if((null===X||void 0===X||!X.length)&&null!==W&&void 0!==W&&W.processedFees&&Array.isArray(W.processedFees)&&W.processedFees.length>0&&!U){console.log("Initializing fees from feeTable:",W.processedFees);const e=W.processedFees.map((e=>{var t,n,s;return{...e,isChecked:!0,amount_paid:null!==(t=null!==(n=e.amount_paid)&&void 0!==n?n:e.suggested_payment)&&void 0!==t?t:0,note:null!==(s=e.note)&&void 0!==s?s:""}})).sort(((e,t)=>{const n=e.code&&e.code.includes("HP"),s=t.code&&t.code.includes("HP");return n&&!s?-1:!n&&s?1:0}));if(J(e),V(!0),e.length>0&&Z){const t=e.map((e=>e.code));A(t),S(`THU ${t.join(", ")} TH\xc1NG ${Z}`)}}}),[W,X,U,Z]),(0,s.useEffect)((()=>{var e;!M||!H||Q||null!==X&&void 0!==X&&X.length||null!==W&&void 0!==W&&null!==(e=W.processedFees)&&void 0!==e&&e.length||(console.log("Forcing data fetch for MSHS:",M),ne("modal"))}),[M,H,Q,X,W,ne]),(0,s.useEffect)((()=>{se&&se.id&&z(se.id)}),[se]);const{totalPaymentAmount:ie,setTotalPaymentAmount:le,distributePayment:ce,handleTotalPaymentChange:re}=(0,d.Y)(K,J),de=(0,s.useCallback)((()=>K.filter((e=>e.isChecked)).map((e=>{const t=e.isAmountModified?Number(e.amount_paid):e.suggested_payment||0;return e.isNewRow?{code:e.code,amount:t,note:e.note||"",name:e.name||e.code,isNewRow:!0,groupcode:e.groupcode||"OTHER"}:{code:e.code,amount:t,note:e.note||""}}))),[K]),{receiptData:ue,receiptRef:he,pdfLoading:me,isSubmitting:ge,showToast:fe,setShowToast:pe,toastMessage:xe,setToastMessage:be,handlePdfAction:ve,generateReceiptAndSubmit:ye}=(0,u._)({studentData:j.current,transactionId:ee,currentMonth:Z,noiDungHoa:T,totalFeeAmount:ae,processedFees:K,prepareTransactionData:de,domain:y,pendingInvoiceId:O,onSuccess:async e=>{z(null),await ne("invoice"),G(x)}});(0,s.useEffect)((()=>{if(fe){P(!0),$(xe);const e=setTimeout((()=>{P(!1)}),3e3);return()=>clearTimeout(e)}}),[fe,xe]);const je=(0,s.useCallback)((e=>{S(e.target.value)}),[]);(0,s.useEffect)((()=>{K&&K.length>0&&(D(!1),R(!0))}),[K]),(0,s.useEffect)((()=>{k?G(b):L===b&&G(x)}),[k,L]);const we=(0,s.useCallback)(((e,t)=>{J((n=>{const s=n.map((n=>n.code===e?{...n,isChecked:t}:n)),a=s.filter((e=>e.isChecked)),o=a.map((e=>e.code));return A(o),a.length>0&&Z?S(`THU ${o.join(", ")} TH\xc1NG ${Z}`):S(""),s}))}),[Z]),Ne=(0,s.useCallback)(((e,t)=>{J((n=>n.map((n=>n.code===e?{...n,amount_paid:t,isAmountModified:!0}:n))))}),[]),ke=(0,s.useCallback)(((e,t)=>{J((n=>n.map((n=>n.code===e?{...n,default_amount:t}:n))))}),[]),Ce=(0,s.useCallback)(((e,t)=>{J((n=>n.map((n=>n.code===e?{...n,note:t}:n))))}),[]),Te=(0,s.useCallback)(((e,t)=>{J((n=>n.map((n=>n.code===e?{...n,code:t}:n))))}),[]),Se=(0,s.useCallback)(((e,t)=>{J((n=>n.map((n=>n.code===e?{...n,name:t}:n))))}),[]),_e=(0,s.useCallback)((()=>{J((e=>[...e,{code:`OT-${Date.now()}`,name:"",default_amount:0,opening_debt_balance:0,remaining_amount:0,suggested_payment:0,amount_paid:0,isNewRow:!0,isChecked:!0,groupcode:"OTHER",note:""}]))}),[]),Ae=(0,s.useCallback)((async()=>{try{if(!j.current)return console.error("No student data available"),$("Kh\xf4ng c\xf3 d\u1eef li\u1ec7u h\u1ecdc sinh"),P(!0),void setTimeout((()=>P(!1)),3e3);if(!K.filter((e=>e.isChecked)).length)return $("Ch\u1ecdn h\u1ecdc ph\xed mu\u1ed1n thu"),P(!0),void setTimeout((()=>P(!1)),3e3);await ye(),G(b),C(!0)}catch(e){console.error("Error in transaction submission:",e.message),$(`\u0110\xe3 x\u1ea3y ra l\u1ed7i: ${e.message}`),P(!0),setTimeout((()=>P(!1)),3e3)}}),[j,K,ye,G,C,$,P]),Ee=((0,s.useCallback)((async()=>{try{N(!0);const e=de(),t=T||`Thu ${_.join(", ")} th\xe1ng ${Z}`,n={invoice_id:ee,invoice_details:t,mshs:j.current.mshs,transaction_data:e,month:Z,status:"completed",pending_invoice_id:O},s=await fetch(`${y}/api/payment/process`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!s.ok)throw new Error(`Failed to process payment: ${s.statusText}`);const a=await s.json();if("success"!==a.status)throw new Error(a.message||"Unknown error occurred");z(null),await ne("invoice"),G(x),$("Giao d\u1ecbch \u0111\xe3 \u0111\u01b0\u1ee3c x\u1eed l\xfd th\xe0nh c\xf4ng"),P(!0),setTimeout((()=>P(!1)),3e3)}catch(e){console.error("API error:",e.message),$(`\u0110\xe3 x\u1ea3y ra l\u1ed7i khi c\u1eadp nh\u1eadt giao d\u1ecbch: ${e.message}`),P(!0),setTimeout((()=>P(!1)),3e3)}finally{N(!1)}}),[y,de,T,_,Z,ee,O,ne,G,$,P]),(0,s.useCallback)((e=>e||0===e?parseFloat(e).toLocaleString("vi-VN"):"0"),[]));if(Q&&H&&!k)return(0,h.jsxs)("div",{className:"flex flex-col items-center justify-center p-8",children:[(0,h.jsx)(a.Spinner,{className:"h-12 w-12 text-violet-800"}),(0,h.jsx)("p",{className:"mt-4 text-white",children:"\u0110ang t\u1ea3i d\u1eef li\u1ec7u..."})]});if(te&&!k)return(0,h.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-6",children:[(0,h.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,h.jsx)("h3",{className:"font-bold text-lg",children:"L\u1ed7i"}),(0,h.jsx)(a.Button,{variant:"text",color:"blue-gray",onClick:v,className:"p-2 rounded-full hover:bg-gray-200 transition-colors",children:(0,h.jsx)(l.A,{className:"h-6 w-6"})})]}),(0,h.jsxs)("div",{className:"text-red-500 text-center",children:[(0,h.jsx)("p",{className:"text-xl font-bold mb-2",children:"L\u1ed7i khi t\u1ea3i d\u1eef li\u1ec7u"}),(0,h.jsx)("p",{children:te})]}),(0,h.jsx)("div",{className:"flex justify-end mt-4",children:(0,h.jsx)(a.Button,{className:"bg-gray-200 text-gray-700 hover:bg-gray-300 shadow-none",onClick:v,children:"\u0110\xf3ng"})})]});if(!Q&&(!K||0===K.length)&&!k)return(0,h.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-6",children:[(0,h.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,h.jsx)("h3",{className:"font-bold text-lg",children:"Th\xf4ng b\xe1o"}),(0,h.jsx)(a.Button,{variant:"text",color:"blue-gray",onClick:v,className:"p-2 rounded-full hover:bg-gray-200 transition-colors",children:(0,h.jsx)(l.A,{className:"h-6 w-6"})})]}),(0,h.jsx)("p",{className:"text-gray-700 text-center py-4",children:"Kh\xf4ng c\xf3 d\u1eef li\u1ec7u h\u1ecdc ph\xed cho h\u1ecdc sinh n\xe0y."}),(0,h.jsx)("div",{className:"flex justify-end mt-4",children:(0,h.jsx)(a.Button,{className:"bg-gray-200 text-gray-700 hover:bg-gray-300 shadow-none",onClick:v,children:"\u0110\xf3ng"})})]});const Pe=L===x||I&&K.some((e=>e.isChecked));return(0,h.jsxs)("div",{className:"transition-opacity duration-300 ease-in-out",children:[k?(0,h.jsx)(s.Suspense,{fallback:(0,h.jsx)("div",{className:"flex justify-center py-8",children:(0,h.jsx)(a.Spinner,{className:"h-8 w-8 text-violet-800"})}),children:(0,h.jsx)("div",{className:"animate-fade-in",children:(0,h.jsx)(f,{onBack:()=>C(!1),onClose:v,receiptRef:he,receiptData:ue,handlePdfAction:ve,pdfLoading:me,isSubmitting:ge})})}):(0,h.jsxs)("div",{className:"bg-white rounded-lg shadow-md animate-fade-in",children:[(0,h.jsxs)("div",{className:"flex justify-between items-center p-4 border-b",children:[(0,h.jsx)("h3",{className:"font-bold text-lg",children:"Thu h\u1ecdc ph\xed"}),(0,h.jsx)(a.Button,{variant:"text",color:"blue-gray",onClick:v,className:"p-2 rounded-full hover:bg-gray-200 transition-colors",children:(0,h.jsx)(l.A,{className:"h-6 w-6"})})]}),(0,h.jsxs)("div",{className:"p-4 space-y-4",children:[(0,h.jsx)(s.Suspense,{fallback:(0,h.jsx)("div",{className:"flex justify-center py-4",children:(0,h.jsx)(a.Spinner,{className:"h-8 w-8 text-violet-800"})}),children:(0,h.jsx)(m,{studentName:q,studentData:j.current,transactionId:ee,currentDay:Y,currentMonth:Z,noiDungHoaDown:T,onNoiDungChange:je})}),I?(0,h.jsx)(s.Suspense,{fallback:(0,h.jsx)("div",{className:"w-full flex justify-center items-center py-8",children:(0,h.jsx)(a.Spinner,{className:"h-8 w-8 text-violet-800"})}),children:(0,h.jsx)(g,{processedFees:K,feeTable:W,handleCheck:we,handlePaidAmount:Ne,handleDebt:ke,handleNote:Ce,handleFeeCode:Te,handleFeeName:Se,formatCurrency:Ee,addNewRow:_e,totalPaymentAmount:ie,setTotalPaymentAmount:le,distributePayment:ce,handleTotalPaymentChange:re})}):(0,h.jsx)("div",{className:"w-full flex justify-center items-center py-8",children:(0,h.jsx)(a.Spinner,{className:"h-8 w-8 text-violet-800"})})]}),(0,h.jsxs)("div",{className:"flex items-center justify-end p-4 gap-4 border-t bg-gray-50",children:[(0,h.jsx)(a.Button,{className:"bg-gray-200 text-gray-700 hover:bg-gray-300 shadow-none",onClick:v,children:"\u0110\xf3ng"}),(0,h.jsx)(a.Button,{className:ge?"bg-violet-300 text-white shadow-md":"bg-violet-700 hover:bg-violet-800 text-white shadow-md",disabled:ge||!I||L===x,onClick:()=>{ge||L===x||Ae()},children:L===x?"\u0110\xe3 thu h\u1ecdc ph\xed":"Thu H\u1ecdc Ph\xed"}),(0,h.jsx)(a.Button,{className:(Pe?"bg-blue-600 hover:bg-blue-700":"bg-blue-300")+" text-white shadow-md",disabled:!Pe,onClick:()=>C(!0),children:"In bi\xean lai"})]})]}),E&&(0,h.jsx)(c.y,{message:F})]})},y=s.memo(v)}}]);
//# sourceMappingURL=787.69930131.chunk.js.map