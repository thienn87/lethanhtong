"use strict";(self.webpackChunktranslate_editor=self.webpackChunktranslate_editor||[]).push([[622],{4058:(e,t,n)=>{n.d(t,{_:()=>i});var o=n(5043),a=n(544);const i=(e,t)=>{const n=(0,a.T)(),[i,s]=(0,o.useState)(!1),[r,d]=(0,o.useState)({}),[c,u]=(0,o.useState)([]),[l,f]=(0,o.useState)(""),[m,p]=(0,o.useState)(""),[g,h]=(0,o.useState)(null),[_,y]=(0,o.useState)(!1),[S,b]=(0,o.useState)(null),w=(0,o.useRef)(!1),F=(0,o.useCallback)((async function(){let o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"modal";if(!e||!t||w.current)return null;try{w.current=!0,s(!0),h(null);const t=(new Date).getMonth()+1,a=(new Date).getFullYear(),i=`${n}/api/tuition-fee-listings/by-mshs?mshs=${encodeURIComponent(e)}&month=${t}&year=${a}&action=${encodeURIComponent(o)}`;console.log("Fetching tuition fee data:",i);const r=await fetch(i,{method:"GET",headers:{"Content-Type":"application/json"}});if(!r.ok)throw new Error(`Failed to fetch tuition fee data: ${r.statusText}`);const c=await r.json();if("success"===c.status&&c.data){const n=c.data;return d(n),n.invoice_id&&(p(n.invoice_id),b({id:n.invoice_id,mshs:e,month:t,year:a})),f(t.toString()),u(n.processedFees||[]),y(!0),n}return null}catch(g){return console.error("Error fetching tuition fee data:",g),h(g.message),null}finally{s(!1),w.current=!1}}),[n,e,t]),T=(0,o.useCallback)((async()=>{if(S&&S.id)try{const e=parseInt(S.month,10);(await fetch(`${n}/api/invoice/delete`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({invoice_id:S.id,year:S.year,month:e})})).ok?(console.log("Successfully deleted pending invoice:",S.id),b(null)):console.error("Failed to delete pending invoice")}catch(g){console.error("Error deleting pending invoice:",g)}}),[n,S]);return(0,o.useEffect)((()=>{e&&t&&!_&&F()}),[e,t,_,F]),(0,o.useEffect)((()=>()=>{T()}),[T]),{loading:i,feeTable:r,processedFees:c,currentMonth:l,transactionId:m,error:g,fetchTuitionFeeData:F,pendingInvoice:S,deletePendingInvoice:T,totalFeeAmount:c.reduce(((e,t)=>e+(t.suggested_payment||0)),0)}}},6468:(e,t,n)=>{n.d(t,{Y:()=>a});var o=n(5043);const a=(e,t)=>{const[n,a]=(0,o.useState)(0),[i,s]=(0,o.useState)(0),[r,d]=(0,o.useState)([]);(0,o.useEffect)((()=>{e&&Array.isArray(e)&&d(e)}),[e]);const c=(0,o.useCallback)((n=>{if(!n||n<=0||!e||!e.length)return e;const o=e.filter((e=>e.isChecked));if(!o.length)return e;const a=[...e];for(let e=0;e<a.length;e++)a[e].isChecked&&(a[e]={...a[e],amount_paid:0,isAmountModified:!0});const i=o.filter((e=>e.code&&e.code.includes("HP"))),s=o.filter((e=>e.code&&e.code.includes("BT"))),r=o.filter((e=>e.code&&e.code.includes("NT"))),c=o.filter((e=>!e.code||!e.code.includes("HP")&&!e.code.includes("BT")&&!e.code.includes("NT"))),u=[...i].sort(((e,t)=>e.code.localeCompare(t.code))),l=[...s].sort(((e,t)=>e.code.localeCompare(t.code))),f=[...r].sort(((e,t)=>e.code.localeCompare(t.code))),m=[...c].sort(((e,t)=>(e.code||"").localeCompare(t.code||""))),p=[...u,...l,...f,...m],g=u.reduce(((e,t)=>e+parseFloat(t.suggested_payment||0)),0),h=l.reduce(((e,t)=>e+parseFloat(t.suggested_payment||0)),0),_=f.reduce(((e,t)=>e+parseFloat(t.suggested_payment||0)),0),y=m.reduce(((e,t)=>e+parseFloat(t.suggested_payment||0)),0),S=g+h+_+y;if(Math.abs(n-S)<.01)for(const t of p){const n=e.findIndex((e=>e.code===t.code));-1!==n&&(a[n]={...a[n],amount_paid:parseFloat(t.suggested_payment||0),isAmountModified:!0})}else{let t=n;const o=Math.floor(t/S);if(o>0&&S>0){for(const t of p){const n=e.findIndex((e=>e.code===t.code));if(-1===n)continue;const i=parseFloat(t.suggested_payment||0);a[n]={...a[n],amount_paid:i*o,isAmountModified:!0}}t-=S*o}if(t>0){if(g>0)for(const n of u){const o=e.findIndex((e=>e.code===n.code));if(-1===o)continue;const i=parseFloat(n.suggested_payment||0),s=parseFloat(a[o].amount_paid||0);if(!(t>=i)){a[o]={...a[o],amount_paid:s+t,isAmountModified:!0},t=0;break}if(a[o]={...a[o],amount_paid:s+i,isAmountModified:!0},t-=i,t<=0)break}if(t>0&&h>0)for(const n of l){const o=e.findIndex((e=>e.code===n.code));if(-1===o)continue;const i=parseFloat(n.suggested_payment||0),s=parseFloat(a[o].amount_paid||0);if(!(t>=i)){a[o]={...a[o],amount_paid:s+t,isAmountModified:!0},t=0;break}if(a[o]={...a[o],amount_paid:s+i,isAmountModified:!0},t-=i,t<=0)break}if(t>0&&_>0)for(const n of f){const o=e.findIndex((e=>e.code===n.code));if(-1===o)continue;const i=parseFloat(n.suggested_payment||0),s=parseFloat(a[o].amount_paid||0);if(!(t>=i)){a[o]={...a[o],amount_paid:s+t,isAmountModified:!0},t=0;break}if(a[o]={...a[o],amount_paid:s+i,isAmountModified:!0},t-=i,t<=0)break}if(t>0&&y>0)for(const n of m){const o=e.findIndex((e=>e.code===n.code));if(-1===o)continue;const i=parseFloat(n.suggested_payment||0),s=parseFloat(a[o].amount_paid||0);if(!(t>=i)){a[o]={...a[o],amount_paid:s+t,isAmountModified:!0},t=0;break}if(a[o]={...a[o],amount_paid:s+i,isAmountModified:!0},t-=i,t<=0)break}if(t>0){let n=[...p];for(;t>0&&n.length>0;){const o=n.shift(),i=e.findIndex((e=>e.code===o.code));if(-1===i)continue;const s=parseFloat(o.suggested_payment||0),r=parseFloat(a[i].amount_paid||0);if(!(t>=s)){a[i]={...a[i],amount_paid:r+t,isAmountModified:!0},t=0;break}a[i]={...a[i],amount_paid:r+s,isAmountModified:!0},t-=s}}}}for(let e=0;e<a.length;e++)void 0!==a[e].amount_paid&&(a[e].amount_paid=Math.round(100*a[e].amount_paid)/100);if(d(a),"function"===typeof t)try{t(a)}catch(b){console.error("Error updating fee items:",b)}return a}),[e]);(0,o.useEffect)((()=>{if(!r||!r.length)return;const e=r.filter((e=>e.isChecked)).reduce(((e,t)=>e+parseFloat(t.amount_paid||t.suggested_payment||0)),0);s(e)}),[r]);const u=(0,o.useCallback)((e=>{const t=parseFloat(e.target.value)||0;return a(t),c(t)}),[c]);return{totalPaymentAmount:n,setTotalPaymentAmount:a,totalFeeAmount:i,distributePayment:c,handleTotalPaymentChange:u,feeItems:r}}},7176:(e,t,n)=>{n.d(t,{_:()=>r});var o=n(5043),a=n(7762),i=n(5239),s=n.n(i);const r=e=>{let{studentData:t,transactionId:n,currentMonth:i,noiDungHoa:r,totalFeeAmount:d,processedFees:c,prepareTransactionData:u,domain:l,pendingInvoiceId:f,onSuccess:m}=e;const[p,g]=(0,o.useState)(null),[h,_]=(0,o.useState)(!1),[y,S]=(0,o.useState)(!1),[b,w]=(0,o.useState)(!1),[F,T]=(0,o.useState)(""),k=(0,o.useRef)(null),v=(0,o.useCallback)((async()=>{try{if(!t)throw new Error("No student data available");const e=c.filter((e=>e.isChecked));if(!e.length)throw new Error("No fees selected");const o=e.reduce(((e,t)=>e+parseFloat(t.amount_paid||0)),0),a=e.map((e=>e.code)),s=r||`Thu ${a.join(", ")} th\xe1ng ${i}`,d={soChungTu:n,tenHocSinh:t.name,mshs:t.mshs||"",lop:t?`${t.grade}${t.class}`:"",dienGiai:s,note:s,soTien:o,ngayThu:(new Date).toISOString(),student:t,invoice_id:n,student_name:t.name,class:t?`${t.grade}${t.class}`:"",amount_paid:o,invoice_details:s,created_at:(new Date).toISOString(),transactions:e.map((e=>({id:`preview-${e.code}`,paid_code:e.code,amount_paid:parseFloat(e.amount_paid||0),tuition_name:e.name||e.code,created_at:(new Date).toISOString()}))),isSubmitting:!0};g(d),S(!0);const p=u(),h={invoice_id:n,invoice_details:s,mshs:t.mshs,transaction_data:p,month:i,status:"completed",pending_invoice_id:f},_=await fetch(`${l}/api/payment/process`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(h)});if(!_.ok)throw new Error(`Failed to process payment: ${_.statusText}`);const y=await _.json();if("success"!==y.status)throw new Error(y.message||"Unknown error occurred");const b={...d,soChungTu:y.data.invoice_id,invoice_id:y.data.invoice_id,ngayThu:y.data.created_at,created_at:y.data.created_at,isSubmitting:!1};return g(b),m&&m(y.data),T("Giao d\u1ecbch \u0111\xe3 \u0111\u01b0\u1ee3c x\u1eed l\xfd th\xe0nh c\xf4ng"),w(!0),setTimeout((()=>w(!1)),3e3),b}catch(e){return console.error("Error processing payment:",e),p&&g({...p,isSubmitting:!1,hasError:!0,errorMessage:e.message}),T(`L\u1ed7i khi x\u1eed l\xfd giao d\u1ecbch: ${e.message}`),w(!0),setTimeout((()=>w(!1)),3e3),null}finally{S(!1)}}),[t,c,r,i,n,u,l,f,m]),C=(0,o.useCallback)((async function(){_(!0);try{if(!k.current)throw new Error("Receipt element not found");{const e=k.current,t=await s()(e,{scale:2,logging:!1,useCORS:!0,allowTaint:!0}),n=t.toDataURL("image/png"),o=new a.uE({orientation:"landscape",unit:"mm",format:"a5"}),i=o.internal.pageSize.getWidth(),r=o.internal.pageSize.getHeight(),d=t.width,c=t.height,u=Math.min(i/d,r/c),l=(i-d*u)/2,f=(r-c*u)/2;o.addImage(n,"PNG",l,f,d*u,c*u),null!==p&&void 0!==p&&p.isSubmitting&&(o.setTextColor(200,0,0),o.setFont("helvetica","bold"),o.setFontSize(30),o.text("\u0110ANG X\u1eec L\xdd",o.internal.pageSize.getWidth()/2,o.internal.pageSize.getHeight()/2,{align:"center",angle:45}));const m=o.output("blob"),g=URL.createObjectURL(m),h="width=800,height=600,menubar=yes,location=yes,resizable=yes,scrollbars=yes,status=yes",_=window.open(g,"_blank",h);if(!_)throw new Error("Kh\xf4ng th\u1ec3 m\u1edf c\u1eeda s\u1ed5 in. Vui l\xf2ng ki\u1ec3m tra c\xe0i \u0111\u1eb7t tr\xecnh duy\u1ec7t c\u1ee7a b\u1ea1n.");_.onunload=function(){URL.revokeObjectURL(g)},_.addEventListener("load",(function(){setTimeout((function(){_.print(),_.addEventListener("afterprint",(function(){setTimeout((function(){_.close()}),500)}))}),1e3)})),T("\u0110\xe3 g\u1eedi bi\xean lai \u0111\u1ebfn m\xe1y in"),w(!0),setTimeout((()=>w(!1)),3e3)}}catch(e){console.error("Error generating PDF:",e),T("L\u1ed7i khi t\u1ea1o PDF: "+e.message),w(!0),setTimeout((()=>w(!1)),3e3)}finally{_(!1)}}),[t,n,p]);return{receiptData:p,setReceiptData:g,receiptRef:k,pdfLoading:h,isSubmitting:y,showToast:b,setShowToast:w,toastMessage:F,setToastMessage:T,handlePdfAction:C,generateReceiptAndSubmit:v}}}}]);
//# sourceMappingURL=622.d3100307.chunk.js.map